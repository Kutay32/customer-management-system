<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Page Loader -->
    <div class="page-loader">
        <div class="loader"></div>
    </div>

    <div class="container">
        <h1 class="mb-4">Customer Management System</h1>

        <div class="row g-3 mb-4 stats-row">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <p class="stats-label">Total Customers</p>
                        <h3 id="totalCustomers" class="stats-value">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon bg-success">
                        <i class="fas fa-phone-volume"></i>
                    </div>
                    <div>
                        <p class="stats-label">With Phone</p>
                        <h3 id="customersWithPhone" class="stats-value">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div>
                        <p class="stats-label">With Address</p>
                        <h3 id="customersWithAddress" class="stats-value">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Customer Form -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 id="formTitle"><i class="fas fa-user-plus me-2"></i>Add New Customer</h5>
                    </div>
                    <div class="card-body">
                        <form id="customerForm">
                            <input type="hidden" id="customerId">
                            <div class="mb-3">
                                <label for="name" class="form-label"><i class="fas fa-user me-2"></i>Name</label>
                                <input type="text" class="form-control" id="name" placeholder="Enter full name" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label"><i class="fas fa-envelope me-2"></i>Email</label>
                                <input type="email" class="form-control" id="email" placeholder="Enter email address" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label"><i class="fas fa-phone me-2"></i>Phone</label>
                                <input type="text" class="form-control" id="phone" placeholder="Enter phone number">
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Address</label>
                                <textarea class="form-control" id="address" rows="3" placeholder="Enter full address"></textarea>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Customer
                                </button>
                                <button type="button" id="cancelBtn" class="btn btn-secondary hidden">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Customer List -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex flex-column flex-lg-row gap-3 justify-content-between align-items-lg-center">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Customer List</h5>
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <div class="input-group search-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, phone..." aria-label="Search customers">
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" title="Clear search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <select id="sortSelect" class="form-select form-select-sm w-auto">
                                    <option value="name:asc">Name (A-Z)</option>
                                    <option value="name:desc">Name (Z-A)</option>
                                    <option value="email:asc">Email (A-Z)</option>
                                    <option value="email:desc">Email (Z-A)</option>
                                    <option value="id:desc">Newest</option>
                                    <option value="id:asc">Oldest</option>
                                </select>
                                <select id="perPageSelect" class="form-select form-select-sm w-auto">
                                    <option value="5">5 / page</option>
                                    <option value="10" selected>10 / page</option>
                                    <option value="20">20 / page</option>
                                    <option value="50">50 / page</option>
                                </select>
                                <button class="btn btn-outline-light btn-sm" id="refreshBtn" title="Refresh">
                                    <i class="fas fa-rotate"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small id="resultsCount" class="text-white-50">Showing 0 customers</small>
                            <small class="text-white-50">Tip: Click a row to prefill the form</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-hashtag me-1"></i>ID</th>
                                        <th><i class="fas fa-user me-1"></i>Name</th>
                                        <th><i class="fas fa-envelope me-1"></i>Email</th>
                                        <th><i class="fas fa-phone me-1"></i>Phone</th>
                                        <th><i class="fas fa-map-marker-alt me-1"></i>Address</th>
                                        <th><i class="fas fa-check-circle me-1"></i>Status</th>
                                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customerList">
                                    <!-- Customer data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-wrapper">
                            <button class="btn btn-outline-secondary btn-sm" id="prevPageBtn">
                                <i class="fas fa-chevron-left me-1"></i>Prev
                            </button>
                            <div id="paginationNumbers" class="pagination-numbers"></div>
                            <button class="btn btn-outline-secondary btn-sm" id="nextPageBtn">
                                Next<i class="fas fa-chevron-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const state = {
            page: 1,
            perPage: 10,
            search: '',
            sortBy: 'name',
            sortDir: 'asc',
            total: 0,
            pages: 1,
            lastActionId: null
        };

        let searchTimeout;

        document.addEventListener('DOMContentLoaded', function() {
            // Hide loader when page is loaded
            setTimeout(function() {
                document.querySelector('.page-loader').classList.add('loaded');
            }, 800);

            // Load customers when page loads
            loadCustomers();
            loadStats();

            // Form submission
            document.getElementById('customerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCustomer();
            });

            // Cancel button
            document.getElementById('cancelBtn').addEventListener('click', function() {
                resetForm();
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                state.search = e.target.value.trim();
                state.page = 1;
                debounceLoadCustomers();
            });

            document.getElementById('clearSearchBtn').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                state.search = '';
                state.page = 1;
                loadCustomers();
            });

            document.getElementById('sortSelect').addEventListener('change', function(e) {
                const [sortBy, sortDir] = e.target.value.split(':');
                state.sortBy = sortBy;
                state.sortDir = sortDir;
                state.page = 1;
                loadCustomers();
            });

            document.getElementById('perPageSelect').addEventListener('change', function(e) {
                state.perPage = parseInt(e.target.value, 10);
                state.page = 1;
                loadCustomers();
            });

            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadCustomers();
                loadStats();
            });

            document.getElementById('prevPageBtn').addEventListener('click', function() {
                if (state.page > 1) {
                    loadCustomers(state.page - 1);
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', function() {
                if (state.page < state.pages) {
                    loadCustomers(state.page + 1);
                }
            });

            // Add tooltip-like hover effects to table headers
            document.querySelectorAll('th').forEach(th => {
                th.setAttribute('title', `Sort by ${th.textContent.trim()}`);
            });

            // Add animation to form icons
            document.querySelectorAll('.form-label i').forEach(icon => {
                icon.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.2) rotate(5deg)';
                });
                icon.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) rotate(0)';
                });
            });
        });

        function debounceLoadCustomers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadCustomers();
            }, 300);
        }

        // Load all customers
        function loadCustomers(page = state.page) {
            state.page = page;
            const params = new URLSearchParams({
                search: state.search,
                page: state.page,
                per_page: state.perPage,
                sort_by: state.sortBy,
                sort_dir: state.sortDir
            });

            fetch(`/api/customers?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    return response.json();
                })
                .then(data => {
                    state.total = data.total;
                    state.pages = data.pages || 1;
                    displayCustomers(data.items);
                    updateResultsCount();
                    updatePagination();
                })
                .catch(error => {
                    console.error('Error loading customers:', error);
                    showNotification('Error loading customers', 'danger');
                });
        }

        function loadStats() {
            fetch('/api/customers/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    return response.json();
                })
                .then(stats => {
                    document.getElementById('totalCustomers').textContent = stats.total;
                    document.getElementById('customersWithPhone').textContent = stats.with_phone;
                    document.getElementById('customersWithAddress').textContent = stats.with_address;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // Display customers in the table
        function displayCustomers(customers) {
            const customerList = document.getElementById('customerList');
            customerList.innerHTML = '';

            if (customers.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-info-circle me-2"></i>
                        ${state.search ? 'No matching customers found' : 'No customers found'}
                    </td>
                `;
                customerList.appendChild(emptyRow);
                return;
            }

            customers.forEach(customer => {
                const row = document.createElement('tr');
                if (state.lastActionId === customer.id) {
                    row.classList.add('highlight');
                }
                row.addEventListener('click', function(event) {
                    if (event.target.closest('button')) {
                        return;
                    }
                    editCustomer(customer.id);
                });

                const statusBadge = getStatusBadge(customer);
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone || '<span class="text-muted">Not provided</span>'}</td>
                    <td>${customer.address || '<span class="text-muted">Not provided</span>'}</td>
                    <td>${statusBadge}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyEmail('${customer.email}')">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editCustomer(${customer.id})">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">
                            <i class="fas fa-trash-alt me-1"></i>Delete
                        </button>
                    </td>
                `;
                customerList.appendChild(row);
            });
        }

        function getStatusBadge(customer) {
            const hasPhone = customer.phone && customer.phone.trim().length > 0;
            const hasAddress = customer.address && customer.address.trim().length > 0;

            if (hasPhone && hasAddress) {
                return '<span class="badge status-badge status-complete"><i class="fas fa-check-circle me-1"></i>Complete</span>';
            }
            if (hasPhone || hasAddress) {
                return '<span class="badge status-badge status-partial"><i class="fas fa-circle-half-stroke me-1"></i>Partial</span>';
            }
            return '<span class="badge status-badge status-missing"><i class="fas fa-circle-xmark me-1"></i>Missing</span>';
        }

        // Save customer (create or update)
        function saveCustomer() {
            const customerId = document.getElementById('customerId').value;
            const customerData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };

            const url = customerId ? `/api/customers/${customerId}` : '/api/customers';
            const method = customerId ? 'PUT' : 'POST';
            const actionText = customerId ? 'updated' : 'added';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customerData)
            })
            .then(async response => {
                const contentType = response.headers.get('content-type') || '';
                const data = contentType.includes('application/json') ? await response.json() : null;
                if (!response.ok) {
                    const errorMessage = data?.errors
                        ? Object.values(data.errors).join(' ')
                        : (data?.message || 'Network response was not ok.');
                    throw new Error(errorMessage);
                }

                resetForm();
                state.lastActionId = data?.id || null;
                loadCustomers();
                loadStats();
                showNotification(`Customer ${actionText} successfully!`, 'success');
            })
            .catch(error => {
                console.error(`Error ${actionText} customer:`, error);
                showNotification(error.message || `Error ${actionText} customer`, 'danger');
            });
        }

        // Edit customer
        function editCustomer(id) {
            fetch(`/api/customers/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    return response.json();
                })
                .then(customer => {
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('name').value = customer.name;
                    document.getElementById('email').value = customer.email;
                    document.getElementById('phone').value = customer.phone || '';
                    document.getElementById('address').value = customer.address || '';

                    document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>Edit Customer';
                    document.getElementById('cancelBtn').classList.remove('hidden');

                    // Scroll to form on mobile
                    if (window.innerWidth < 992) {
                        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
                    }
                })
                .catch(error => {
                    console.error('Error loading customer details:', error);
                    showNotification('Error loading customer details', 'danger');
                });
        }

        // Delete customer
        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                fetch(`/api/customers/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    if (state.page > 1 && state.total - 1 <= (state.page - 1) * state.perPage) {
                        state.page -= 1;
                    }
                    loadCustomers(state.page);
                    loadStats();
                    showNotification('Customer deleted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error deleting customer:', error);
                    showNotification('Error deleting customer', 'danger');
                });
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Add New Customer';
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        function updateResultsCount() {
            const start = state.total === 0 ? 0 : (state.page - 1) * state.perPage + 1;
            const end = Math.min(state.page * state.perPage, state.total);
            const suffix = state.search ? `for "${state.search}"` : '';
            document.getElementById('resultsCount').textContent = `Showing ${start}-${end} of ${state.total} ${suffix}`.trim();
        }

        function updatePagination() {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const paginationNumbers = document.getElementById('paginationNumbers');

            prevBtn.disabled = state.page <= 1;
            nextBtn.disabled = state.page >= state.pages;
            paginationNumbers.innerHTML = '';

            const maxButtons = 5;
            let startPage = Math.max(1, state.page - Math.floor(maxButtons / 2));
            let endPage = Math.min(state.pages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.className = `btn btn-sm ${i === state.page ? 'btn-primary' : 'btn-outline-secondary'}`;
                button.textContent = i;
                button.addEventListener('click', () => loadCustomers(i));
                paginationNumbers.appendChild(button);
            }
        }

        function copyEmail(email) {
            navigator.clipboard.writeText(email)
                .then(() => {
                    showNotification('Email copied to clipboard', 'success');
                })
                .catch(() => {
                    showNotification('Unable to copy email', 'warning');
                });
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            // Set icon based on notification type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            else if (type === 'danger') icon = 'exclamation-circle';
            else if (type === 'warning') icon = 'exclamation-triangle';

            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // Add notification to the page
            document.body.appendChild(notification);

            // Add styles
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                zIndex: '1050',
                display: 'flex',
                alignItems: 'center',
                minWidth: '300px',
                padding: '15px',
                borderRadius: 'var(--border-radius)',
                background: 'var(--glass-bg)',
                backdropFilter: 'blur(10px)',
                border: 'var(--glass-border)',
                boxShadow: 'var(--glass-shadow)',
                animation: 'slideIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards'
            });

            // Add specific styles based on notification type
            const colors = {
                success: { bg: 'rgba(76, 201, 240, 0.1)', color: 'var(--success-color)' },
                danger: { bg: 'rgba(249, 65, 68, 0.1)', color: 'var(--danger-color)' },
                warning: { bg: 'rgba(248, 150, 30, 0.1)', color: 'var(--warning-color)' },
                info: { bg: 'rgba(67, 97, 238, 0.1)', color: 'var(--primary-color)' }
            };

            const typeColor = colors[type] || colors.info;
            notification.style.borderLeft = `4px solid ${typeColor.color}`;
            notification.style.backgroundColor = typeColor.bg;

            // Style the icon
            const iconElement = notification.querySelector('.notification-icon');
            Object.assign(iconElement.style, {
                color: typeColor.color,
                fontSize: '1.5rem',
                marginRight: '15px'
            });

            // Style the content
            const contentElement = notification.querySelector('.notification-content');
            Object.assign(contentElement.style, {
                flex: '1'
            });

            // Style the close button
            const closeButton = notification.querySelector('.notification-close');
            Object.assign(closeButton.style, {
                background: 'none',
                border: 'none',
                color: 'var(--gray-color)',
                cursor: 'pointer',
                fontSize: '0.9rem',
                padding: '5px',
                marginLeft: '10px',
                transition: 'var(--transition)'
            });

            // Add hover effect to close button
            closeButton.addEventListener('mouseenter', function() {
                this.style.color = typeColor.color;
                this.style.transform = 'scale(1.2)';
            });

            closeButton.addEventListener('mouseleave', function() {
                this.style.color = 'var(--gray-color)';
                this.style.transform = 'scale(1)';
            });

            // Add click handler to close button
            closeButton.addEventListener('click', function() {
                closeNotification(notification);
            });

            // Add keyframes for animation if not already added
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.innerHTML = `
                    @keyframes slideIn {
                        from { transform: translateX(120%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(120%); opacity: 0; }
                    }
                    @keyframes bounce {
                        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-10px); }
                        60% { transform: translateY(-5px); }
                    }
                `;
                document.head.appendChild(style);
            }

            // Add a slight bounce animation after sliding in
            setTimeout(() => {
                notification.style.animation = 'bounce 0.8s ease';
            }, 500);

            // Function to close notification
            function closeNotification(notif) {
                notif.style.animation = 'slideOut 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards';
                setTimeout(() => {
                    notif.remove();
                }, 500);
            }

            // Auto-remove notification after 5 seconds
            const timeout = setTimeout(() => {
                closeNotification(notification);
            }, 5000);

            // Clear timeout if manually closed
            closeButton.addEventListener('click', function() {
                clearTimeout(timeout);
            });
        }
    </script>
</body>
</html>
